<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Men√∫ - MenuLab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Grupo 1 -->
  <link href="https://fonts.googleapis.com/css2?family=Almendra+Display&family=Amatic+SC:wght@400;700&family=Anton&family=Caveat:wght@400;700&family=Codystar:wght@300;400&family=Cormorant+Garamond:wght@400;700&family=Coral+Pixels&display=swap" rel="stylesheet">

  <!-- Grupo 2 -->
  <link href="https://fonts.googleapis.com/css2?family=Ewert&family=Indie+Flower&family=Merriweather:wght@400;700&family=Milonga&family=Monoton&family=Montserrat:wght@400;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">

  <!-- Grupo 3 -->
  <link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&family=Chokokutai&family=Pacifico&family=Playfair+Display:wght@400;700&family=Quicksand:wght@400;700&family=Ranchers:wght@400;700&family=Rubik+Wet+Paint&family=Sora:wght@400;700&family=Source+Code+Pro:wght@400;700&family=Tangerine:wght@400;700&family=Vast+Shadow&display=swap" rel="stylesheet">

<style>
  :root {
    --color-nombre-resto: #000;
    --color-nombre-slogan: #000;
    --color-categoria: #000;
    --color-subcategoria: #000;
    --color-plato: #000;
    --color-descripcion: #555;
    --color-precio: #000;
    --color-info-resto: #000;
    --color-bg: #fff;

    --font-nombre-resto: 'Lato', sans-serif;
    --font-nombre-slogan: 'Lato', sans-serif;
    --font-categoria: 'Lato', sans-serif;
    --font-subcategoria: 'Lato', sans-serif;
    --font-plato: 'Lato', sans-serif;
    --font-descripcion: 'Lato', sans-serif;
    --font-precio: 'Lato', sans-serif;
    --font-info-resto: 'Lato', sans-serif;

    --bg-opacity: 0.15;
    --bg-size-scale: 100%;
    --menu-columns: 2;
    --firulete-opacity: 0.4;

    --logo-size: 100px;
    --size-nombre-resto: 2rem;
    --size-nombre-slogan: 1rem;
    --size-categoria: 1.5rem;
    --size-subcategoria: 1rem;
    --size-plato: 0.95rem;
    --size-descripcion: 0.85rem;
    --size-precio: 0.9rem;
    --size-info-resto: 0.8rem;
    --tracking: 0px;
  }

  body {
    font-family: 'Lato', sans-serif;
    margin: 0 auto;
    background: var(--color-bg);
    letter-spacing: var(--tracking);
    color: var(--color-plato);
    transition: all 0.25s ease;
    background-position: center center; /* üîπ Centrado vertical y horizontal */
    background-repeat: no-repeat;
    background-size: cover; /* o ‚Äúcontain‚Äù si quer√©s que no recorte */
  }

  /* === FONDO === */
  .print-background {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("") no-repeat center center;
    background-size: var(--bg-size-scale);
    opacity: var(--bg-opacity);
    z-index: -1;
    pointer-events: none;
  }

/* Bloque general del encabezado */
.resto-top {
  display: flex;
  justify-content: center;
  width: 100%;
  align-items: center;
  gap: var(--logo-gap, 10px); /* ‚Üê valor base por si no se define */
  width: 100%;
}

.resto-header {
  flex-shrink: 0;
  display: flex;
  justify-content: center;
  width: auto;
  transform-origin: center center;
  transition: padding-top 0.25s ease; /* üü¢ agrega transici√≥n suave */  
}

.resto-header img {
  width: var(--logo-size, 110px);
  height: var(--logo-size, 110px);
  border-radius: 50%;
  object-fit: cover;
  opacity: var(--logo-opacity, 1);
  transition: transform 0.25s ease, opacity 0.25s ease;
  transform-origin: center center;
}

/* Texto */
.resto-info {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: flex-start;
  line-height: 1.1;
}

.resto-info h1 {
  font-family: var(--font-nombre-resto);
  font-size: var(--size-nombre-resto);
  color: var(--color-nombre-resto);
  margin: 0;
  font-weight: 700;
  line-height: 1.1;
}

.resto-info .resto-slogan {
  font-family: var(--font-nombre-slogan);
  font-size: var(--size-nombre-slogan);
  color: var(--color-nombre-slogan);
  font-style: italic;
  margin: 0.3rem 0 0;
  line-height: 1.1;
}
body .resto-top {
  width: 100%;
  justify-content: center;
}
  #menuTable h3 {
    font-family: var(--font-subcategoria);
    font-size: var(--size-subcategoria);
    color: var(--color-subcategoria);
    font-style: italic;
    margin: 0.4rem 0;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    page-break-after: avoid;
    break-after: avoid;
  }

  /* === CATEGOR√çAS Y PLATOS === */
  h2 {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-family: var(--font-categoria);
    font-size: var(--size-categoria);
    color: var(--color-categoria);
    font-weight: bold;
    text-align: center;
    margin: 1.2rem 0 0.8rem;
    column-span: all;
  }

  h2::before,
  h2::after {
    content: var(--firulete, "‚ú¶ ‚ú¶ ‚ú¶");
    /* üëá el firulete escala autom√°ticamente con la categor√≠a */
    font-size: calc(var(--size-categoria) * 0.6);
    color: var(--color-categoria);
    opacity: var(--firulete-opacity, 0.4);
    transition: font-size 0.25s ease, opacity 0.25s ease;
  }

  .menu-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0.35rem 0;
    break-inside: avoid-column;
    page-break-inside: avoid;
    transition: background 0.2s ease;
  }

  .menu-item:hover {
    background: rgba(0,0,0,0.03);
  }

  .menu-plate {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .menu-plate h4 {
    font-family: var(--font-plato);
    font-size: var(--size-plato);
    color: var(--color-plato);
    margin: 0;
    font-weight: 700;
  }

  .menu-description {
    font-family: var(--font-descripcion);
    font-size: var(--size-descripcion);
    color: var(--color-descripcion);
    margin: 0.2rem 0 0;
  }

  .menu-price {
    font-family: var(--font-precio);
    font-size: var(--size-precio);
    color: var(--color-precio);
    font-weight: bold;
    margin-left: 12px;
    white-space: nowrap;
  }

  .menu-item.destacado {
    background: #f7f7f7 !important;       /* gris muy claro */
    border-left: 4px solid #9e9e9e !important; /* gris medio */
    border-radius: 6px;
    padding: 0.4rem 0.6rem;
    opacity: 0.7;
  }

  /* === FOOTER === */
  .footer {
    font-family: var(--font-info-resto);
    font-size: var(--size-info-resto);
    color: var(--color-info-resto);
    text-align: center;
    margin-top: 0 !important;
    padding: 10px;
    column-span: all;
    position: fixed;
  }

  @media screen {
    .footer {
      position: relative;
      bottom: 0;
      width: 100%;
    }
  }
  /* === RESPONSIVE === */
  @media (max-width: 768px) {
    body {
      column-count: 1 !important;
      padding: 10px;
    }

  }

/* === MODO IMPRESI√ìN AJUSTADO === */
@media print {
  @page {
    size: A4;
    margin: 8mm 8mm 10mm 8mm;
  }

  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  body {
    background: var(--color-bg) !important;
    margin: 0 !important;
  }

  .print-background {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    opacity: var(--bg-opacity) !important;
    background-size: var(--bg-size-scale);
    z-index: -1;
  }

  /* Evita que el header quede solo en una hoja */
  .resto-top {
    break-inside: avoid !important;
    page-break-after: avoid !important;
    margin-bottom: 1rem !important;
  }

  /* Ajusta wrapper para que no fuerce salto de p√°gina */
  #menu-columns-wrapper {
    break-inside: auto;
    page-break-inside: auto;
    overflow: visible;
  }

  /* Footer fijo al final */
  .footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    background: var(--color-bg);
    border-top: 1px solid #ccc;
    color: var(--color-info-resto);
    font-family: var(--font-info-resto);
    font-size: var(--size-info-resto);
    text-align: center;
    padding: 6px 0;
  }

  /* Oculta scrolls visuales */
  html, body {
    overflow: visible !important;
    height: auto !important;
  }

  /* Asegura que las columnas se impriman completas */
  #menu-columns-wrapper .columna {
    page-break-inside: avoid;
  }
}


  #menu-frame {
    border-style: var(--frame-style, none);
    border-color: var(--frame-color, #fff);
    border-width: var(--frame-width, 0px);
    box-sizing: border-box;
    border-radius: 8px;
    transition: all 0.25s ease;
  }

  #menu-inner {
    flex: 1; /* ‚úÖ el contenido ocupa el espacio disponible arriba del footer */
  }

  /* ornamentos: base gen√©rica */
  #menu-frame::before,
  #menu-frame::after {
    content: "";
    position: absolute;
    width: 120px;
    height: 120px;
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 0.4;
    pointer-events: none;
    z-index: -1;
  }

  /* Esquinas inferiores adicionales */
  #menu-frame::before {
    top: -10px;
    left: -10px;
  }
  #menu-frame::after {
    bottom: -10px;
    right: -10px;
    transform: rotate(180deg);
  }
  /* === Bloques de categor√≠a, subcategor√≠a e √≠tems === */
  .categoria-bloque,
  .sub-bloque,
  .menu-item {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* === Categor√≠a principal con marco din√°mico === */
  .categoria-bloque {
    width: 100%;
    border-style: var(--cat-frame-style, none);
    border-color: var(--cat-frame-color, rgba(0,0,0,0.2));
    border-width: var(--cat-frame-width, 0px);
    border-radius: 8px;
    box-sizing: border-box;
    backdrop-filter: blur(1px);
    overflow: hidden;

    /* Espaciados din√°micos seg√∫n grosor del marco */
    padding: calc(10px + var(--cat-frame-width, 0px)) 12px;
    margin-bottom: calc(0.8rem + var(--cat-frame-width, 0px));

    /* Animaci√≥n suave si el usuario cambia grosor o estilo */
    transition: all 0.25s ease;
  }

  /* Evita que se peguen entre s√≠ los marcos */
  .categoria-bloque + .categoria-bloque {
    margin-top: 0.4rem;
  }

  /* === Asegurar que sub-bloques internos respeten espacio interno === */
  .categoria-bloque .sub-bloque {
    margin-top: 0.5rem;
    padding-top: 0.2rem;
  }


/* === Alineaci√≥n de t√≠tulos de categor√≠a por clase === */
body.cat-left   h2 { justify-content: flex-start;  text-align: left;  }
body.cat-center h2 { justify-content: center;      text-align: center;}
body.cat-right  h2 { justify-content: flex-end;    text-align: right; }

.sub-bloque {
  break-inside: avoid;
  page-break-inside: avoid;
  margin-bottom: 1.2rem;
}

/* === SISTEMA DE COLUMNAS CON DIVISORES === */
#menu-columns-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  width: 100%;
  gap: 1rem; /* espacio entre columnas */
  transition: all 0.3s ease;
  position: relative;
}

/* Columna base */
#menu-columns-wrapper .columna {
  flex: 1 1 auto;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 1rem;               /* antes 1.2rem */
  padding: 0 0.25rem;       /* antes 0 1rem ‚Üí reduce espacio lateral */
  position: relative;
}

/* Divisor entre columnas */
#menu-columns-wrapper .columna:not(:last-child)::after {
  content: "";
  position: absolute;
  top: 0;
  right: 0;
  height: 100%;
  width: 0.6px;            /* l√≠nea m√°s fina */
  background-color: rgba(0, 0, 0, 0.08);
}

/* Layout: 1 columna */
body.cols-1 #menu-columns-wrapper {
  display: block !important;
}
body.cols-1 #menu-columns-wrapper .columna {
  width: 100% !important;
  max-width: 100% !important;
  padding: 0 !important;
}
body.cols-1 #menu-columns-wrapper .columna::after {
  display: none !important;
}

/* Layout: 2 columnas */
body.cols-2 #menu-columns-wrapper {
  display: flex !important;
  gap: 0.4rem;             /* üîπ reduce la separaci√≥n entre columnas */
}
body.cols-2 #menu-columns-wrapper .columna {
  width: 49.75%;
  max-width: 49.75%;
}

/* Layout: 3 columnas */
body.cols-3 #menu-columns-wrapper {
  display: flex !important;
  gap: 0.3rem;             /* üîπ m√°s juntas */
}
body.cols-3 #menu-columns-wrapper .columna {
  width: 33%;
  max-width: 33%;
}

/* Header dentro de la primera columna */
body.header-en-primera .resto-top {
  justify-content: center;
  margin-bottom: 1rem;
  column-span: all;
}

/* === üîÑ Indicador de carga con porcentaje === */
#loadingMenu {
  text-align: center;
  color: #333;
  font-family: 'Montserrat', sans-serif;
  padding: 60px 10px;
  font-size: 1.1rem;
  letter-spacing: 0.5px;
}

#progress-bar {
  width: 80%;
  height: 8px;
  background: #e0e0e0;
  border-radius: 6px;
  overflow: hidden;
  margin: 15px auto;
  position: relative;
}

#progress-fill {
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, #1d3557, #457b9d);
  border-radius: 6px;
  transition: width 0.25s ease;
}

#progress-text {
  font-size: 0.9rem;
  color: #555;
  margin-top: 10px;
  font-weight: 500;
}
.hide-frame .menu-container {
  border: none !important;
}
/* Ocultar el marco del men√∫ cuando se exporta a PDF */
.exporting-pdf .menu-container,
.exporting-pdf body {
  border: none !important;
  box-shadow: none !important;
}


</style>

</head>
<body>
  <div id="menu-frame">
    <div id="menu-inner">
      <!-- üåÑ Fondo -->
      <div class="print-background"></div>

      <!-- üè™ Encabezado -->
      <div class="resto-top">
        <div class="resto-header">
          <img src="" alt="" id="logo-resto">
        </div>
        <div class="resto-info">
          <h1 id="nombre-resto"></h1>
          <h3 id="subtitulo-resto" class="resto-slogan"></h3>
        </div>
      </div>

      <!-- üìú Contenido del men√∫ -->
      <div id="menu-columns-wrapper">
        <div id="menuTable"></div>
      </div>
    </div>
    <div class="footer"></div>
  </div>

<script>

  (function() {

  /* === Datos base de ejemplo === */
window.addEventListener("DOMContentLoaded", () => {
  console.log("üëã Menu listo, notificando al editor...");

  // enviamos ready universal
  try {
    window.parent.postMessage({ type: "ready" }, "*");
    console.log("üì§ Primer mensaje ready enviado (universal)");

    // refuerzo cada 1.5s (hasta 3 veces)
    let retries = 0;
    const interval = setInterval(() => {
      if (retries++ >= 3) return clearInterval(interval);
      window.parent.postMessage({ type: "ready" }, "*");
      console.log(`üì§ Reenv√≠o ready #${retries}`);
    }, 1500);
  } catch (err) {
    console.warn("‚ö†Ô∏è Error enviando ready:", err);
  }
});


// === NUEVO BLOQUE DIN√ÅMICO ===

// 1Ô∏è‚É£ Detectar tenant desde la URL
const params = new URLSearchParams(window.location.search);
const tenant = params.get("tenant") || "cafe_central"; // por defecto Caf√© Central

// 2Ô∏è‚É£ Llamar a la API de Apps Script
const API_URL = "https://script.google.com/macros/s/AKfycbyswfpcLHgKj1zAvHgGCpYs6EWLqwfqjEM-mxFErwp_g8jTPr8qi-5tVGfNyXzqGgYG/exec";
// === üîπ CARGAR ESTILO GUARDADO DEL RESTAURANTE ===
async function loadSavedStyle() {
  try {
    const url = `${API_URL}?action=get_style&tenant=${tenant}&_=${Date.now()}`;

    // dev 
    const isLocal = location.hostname.includes("127.0.0.1") || location.hostname.includes("localhost") || location.protocol === "file:";
    const finalUrl = isLocal ? `https://corsproxy.io/?${encodeURIComponent(url)}` : url;
    const res = await fetch(finalUrl);
    // dev
    
    /*
    // prod
    const res = await fetch(url);
    // prod 
*/
    const text = await res.text();
    let estilo;
    try {
      estilo = JSON.parse(text);
    } catch {
      estilo = {};
    }

    aplicarEstilosGuardados(estilo);
    console.log("üé® Estilo aplicado desde hoja users:", estilo);
  } catch (err) {
    console.error("‚ö†Ô∏è No se pudo cargar estilo guardado:", err);
  }
}

async function loadMenu() {
  const stopProgress = showLoading(); // üîπ Inicia loader con barra

  try {
    const res = await fetch(`${API_URL}?tenant=${tenant}`);
    const data = await res.json();

    if (data.info) renderInfo(data.info);
    if (Array.isArray(data.menu)) {
      renderMenu(data.menu);
      setTimeout(capturarBloquesOriginales, 200);
      if (Array.isArray(data.menu)) {
        renderMenu(data.menu);
        setTimeout(() => {
            capturarBloquesOriginales();
            setTimeout(() => aplicarEstilosGuardados(estiloGlobal || {}), 300);
        }, 300);
        }
    } else {
      document.getElementById("menuTable").innerHTML =
        "<p style='text-align:center;color:#999'>Men√∫ no disponible.</p>";
    }

  } catch (err) {
    console.error("‚ö†Ô∏è Error al conectar con la API:", err);
    document.getElementById("menuTable").innerHTML =
      "<p style='text-align:center;color:#999'>Error al conectar con el servidor.</p>";
  } finally {
    // üîπ Finaliza y oculta el loader
    if (typeof stopProgress === "function") stopProgress();
  }
}

function renderMenu(rows) {
  const container = document.getElementById("menuTable");
  if (!container) return;
  container.innerHTML = "";

  // Agrupar por categor√≠a y subcategor√≠a
  const grouped = {};
  rows.forEach(item => {
    const cat = item.categoria || "Sin categor√≠a";
    const sub = item.subcategoria || "-";
    if (!grouped[cat]) grouped[cat] = {};
    if (!grouped[cat][sub]) grouped[cat][sub] = [];
    grouped[cat][sub].push(item);
  });

// Renderizado visual
Object.entries(grouped).forEach(([cat, subs]) => {
  const catDiv = document.createElement("div");
  catDiv.classList.add("categoria-bloque");
  catDiv.dataset.cat = cat;

  // t√≠tulo de categor√≠a (lo usaremos como ‚Äúheader‚Äù cuando repartimos)
  const catTitle = document.createElement("h2");
  catTitle.textContent = cat;
  catDiv.appendChild(catTitle);

  Object.entries(subs).forEach(([sub, items]) => {
    // üëâ cada subcategor√≠a se envuelve en un sub-bloque
    const subBlock = document.createElement("div");
    subBlock.className = "sub-bloque";
    subBlock.dataset.cat = cat;           // para saber a qu√© categor√≠a pertenece
    subBlock.dataset.sub = sub || "-";

    if (sub && sub !== "-") {
      const subTitle = document.createElement("h3");
      subTitle.textContent = sub;
      subBlock.appendChild(subTitle);
    }

    items.forEach(it => {
      const div = document.createElement("div");
      div.className = "menu-item";
      if (it.tags && it.tags.toString().toLowerCase().includes("destacado")) {
        div.classList.add("destacado");
      }
      div.innerHTML = `
        <div class="menu-plate">
          <h4>${it.plato || it.nombre || ""}</h4>
          <p class="menu-description">${it.descripcion || it.desc || ""}</p>
        </div>
        <span class="menu-price">${it.precio || ""}</span>
      `;
      subBlock.appendChild(div);
    });

    catDiv.appendChild(subBlock);
  });

  container.appendChild(catDiv);
});
}

// === Indicador de carga ===
// === Indicador de carga con progreso simulado ===
function showLoading(msg = "Cargando men√∫...") {
  const container = document.getElementById("menuTable");
  if (!container) return;

  // Inserta el contenido del loader
  container.innerHTML = `
    <div id="loadingMenu">
      <i class="fa-solid fa-spinner fa-spin" style="margin-right:6px;color:#1D3557;"></i>${msg}
      <div id="progress-bar">
        <div id="progress-fill"></div>
      </div>
      <div id="progress-text">0%</div>
    </div>
  `;

  let progress = 0;
  const fill = document.getElementById("progress-fill");
  const text = document.getElementById("progress-text");

  // Subida simulada hasta el 90%
  const interval = setInterval(() => {
    if (progress < 90) {
      progress += Math.random() * 8; // avanza con variaciones
      if (progress > 90) progress = 90;
      fill.style.width = `${progress}%`;
      text.textContent = `${Math.floor(progress)}%`;
    }
  }, 250);

  // Devuelve una funci√≥n para completar y cerrar la animaci√≥n
  return function completeProgress() {
    clearInterval(interval);
    fill.style.width = "100%";
    text.textContent = "100%";
    setTimeout(() => {
      const loadingDiv = document.getElementById("loadingMenu");
      if (loadingDiv) loadingDiv.style.opacity = "0";
      setTimeout(() => loadingDiv?.remove(), 400);
    }, 500);
  };
}


// 3Ô∏è‚É£ Ejecutar al cargar
loadMenu();
loadSavedStyle();


function renderInfo(info = {}) {
  const get = (k) => info[k] || "";

  // Logo
  const logo = document.getElementById("logo-resto");
  if (logo && get("logo")) logo.src = get("logo");

  // Nombre y slogan
  const nombreEl = document.getElementById("nombre-resto");
  if (nombreEl) nombreEl.textContent = get("nombre");

  const sloganEl = document.getElementById("subtitulo-resto");
  if (sloganEl) sloganEl.textContent = get("slogan");

  // Footer con info de contacto
  const footer = document.querySelector(".footer");
  if (footer) {
    footer.innerHTML = `
      ${get("direccion") ? `üìç ${get("direccion")} &nbsp;|&nbsp;` : ""}
      ${get("telefono") ? `üìû ${get("telefono")} &nbsp;|&nbsp;` : ""}
      ${get("horarios") ? `üïì ${get("horarios")}` : ""}
    `.trim();
  }

  // Fondo opcional
  const fondo = get("fondo");
  if (fondo) {
    const bg = document.querySelector(".print-background");
    if (bg) bg.style.backgroundImage = `url('${fondo}')`;
  }

  console.log("üß≠ Info del restaurante aplicada:", info);

}

// ====== STATE ======
let bloquesOriginales = [];
let _snapshotDOM = null;
let _headerPlaceholder = null;

// ====== HELPERS ======
function _saveSnapshotIfNeeded() {
  if (_snapshotDOM) return;
  const wrapper = document.getElementById('menu-columns-wrapper');
  if (!wrapper) return;
  _snapshotDOM = document.createElement('div');
  _snapshotDOM.id = '__snapshot';
  // guardamos los nodos hijos originales (categor√≠as renderizadas)
  Array.from(wrapper.childNodes).forEach(n => _snapshotDOM.appendChild(n.cloneNode(true)));
}

function _restoreFromSnapshot() {
  if (!_snapshotDOM) return;
  const wrapper = document.getElementById('menu-columns-wrapper');
  if (!wrapper) return;
  wrapper.innerHTML = '';
  Array.from(_snapshotDOM.childNodes).forEach(n => wrapper.appendChild(n.cloneNode(true)));
}

// ====== CAPTURA ======
function capturarBloquesOriginales() {
  const wrapper = document.getElementById('menu-columns-wrapper');
  const menuTable = document.getElementById('menuTable');
  if (!wrapper || !menuTable) return;

  // Reiniciar snapshot y bloques
  bloquesOriginales = [];
  _snapshotDOM = null;

  // Crear snapshot original desde el contenido real (menuTable)
  _snapshotDOM = document.createElement('div');
  _snapshotDOM.id = '__snapshot';
  Array.from(menuTable.childNodes).forEach(n =>
    _snapshotDOM.appendChild(n.cloneNode(true))
  );

  // Capturar categor√≠as completas
  const cats = Array.from(menuTable.querySelectorAll('.categoria-bloque'));
  bloquesOriginales = cats.map(el => el.cloneNode(true));

  // Placeholder para el header
  if (!_headerPlaceholder) {
    _headerPlaceholder = document.createElement('div');
    _headerPlaceholder.id = '__header_ph';
    const restoTop = document.querySelector('.resto-top');
    if (restoTop && restoTop.parentNode) {
      restoTop.parentNode.insertBefore(_headerPlaceholder, restoTop);
    }
  }

  console.log(`üì¶ Capturados ${bloquesOriginales.length} categor√≠as (refrescado limpio)`);
}


function limpiarWrapper() {
  const wrapper = document.getElementById('menu-columns-wrapper');
  if (!wrapper) return;
  wrapper.querySelectorAll('.columna').forEach(c => c.remove());
}

// ====== DISTRIBUCI√ìN BALANCEADA ======
function distribuirColumnas(cols = 2, headerMode = 'full') {
  const wrapper = document.getElementById('menu-columns-wrapper');
  const restoTop = document.querySelector('.resto-top');
  if (!wrapper || bloquesOriginales.length === 0) {
    console.warn("‚ö†Ô∏è No hay bloques para distribuir");
    return;
  }

  // Limpiar el contenido anterior (incluidas columnas previas)
  wrapper.innerHTML = '';

  // Crear columnas
  const columnas = [];
  const alturas = new Array(cols).fill(0);
  for (let i = 0; i < cols; i++) {
    const col = document.createElement('div');
    col.className = 'columna';
    columnas.push(col);
    wrapper.appendChild(col);
  }

  // Mover el header seg√∫n el modo
  if (restoTop) {
    if (headerMode === 'first') {
      document.body.classList.add('header-en-primera');
      columnas[0].prepend(restoTop);
    } else {
      document.body.classList.remove('header-en-primera');
      if (_headerPlaceholder && _headerPlaceholder.parentNode) {
        _headerPlaceholder.parentNode.insertBefore(restoTop, _headerPlaceholder.nextSibling);
      } else {
        wrapper.parentNode.insertBefore(restoTop, wrapper);
      }
    }
  }

  // Distribuci√≥n balanceada por n√∫mero de √≠tems
  bloquesOriginales.forEach(b => {
    const peso = b.querySelectorAll('.menu-item').length || 1;
    const idxMin = alturas.indexOf(Math.min(...alturas));
    columnas[idxMin].appendChild(b.cloneNode(true));
    alturas[idxMin] += peso;
  });

  console.log(`üß± Distribuidos ${bloquesOriginales.length} bloques en ${cols} columnas (mode=${headerMode})`);
}

// ====== RESTAURAR 1 COLUMNA ======
function restaurarAnchoCompleto() {
  const wrapper = document.getElementById('menu-columns-wrapper');
  const menuTable = document.getElementById('menuTable');
  if (!wrapper || !_snapshotDOM || !menuTable) return;

  // Reset visual
  wrapper.style.display = 'block';
  wrapper.style.gap = '0';
  wrapper.style.justifyContent = 'flex-start';

  // Limpiar y restaurar contenido original del menuTable
  menuTable.innerHTML = '';
  Array.from(_snapshotDOM.childNodes).forEach(n =>
    menuTable.appendChild(n.cloneNode(true))
  );

  // Devolver header a su lugar
  const restoTop = document.querySelector('.resto-top');
  if (restoTop && _headerPlaceholder && _headerPlaceholder.parentNode) {
    _headerPlaceholder.parentNode.insertBefore(restoTop, _headerPlaceholder.nextSibling);
  }

  console.log("üîô Restaurado layout de 1 columna (visual correcto)");
}



window.addEventListener("message", (e) => {
  const { type, data } = e.data || {};
  if (!type) return;
  console.log("üéØ [recv] =>", type, data);

  switch (type) {
    case "init":
      // responder al editor para confirmar disponibilidad (handshake)
      try { window.parent.postMessage({ type: "ready" }, "*"); } catch (err) { /* noop */ }
      console.log("üì§ Respondiendo ready al editor (init recibido)");
      break;
    case "font-section":
      if (data.section && data.font) {
        document.documentElement.style.setProperty(`--font-${data.section}`, data.font);
        // aplica directo tambi√©n a los nodos
        document.querySelectorAll(getSelector(data.section))
          .forEach(el => { el.style.fontFamily = `'${data.font}', sans-serif`; });
      }
      break;

    case "size-section":
      if (data.section && data.value) {
        const rem = `${data.value}rem`;
        document.documentElement.style.setProperty(`--size-${data.section}`, rem);
        document.querySelectorAll(getSelector(data.section))
          .forEach(el => { el.style.fontSize = rem; });
      }
      break;

    case "color-section":
      if (data.section && data.value) {
        document.documentElement.style.setProperty(`--color-${data.section}`, data.value);
        document.querySelectorAll(getSelector(data.section))
          .forEach(el => { el.style.color = data.value; });
      }
      break;

    case "columns":
      document.body.style.columnCount = data;
      document.documentElement.style.setProperty("--menu-columns", data);
      break;

    case "formato":
      document.body.classList.toggle("multi-columnas", data === "columnas-reales");
      break;

    case "firulete":
      document.documentElement.style.setProperty("--firulete", `"${data || ""}"`);
      break;

    case "firulete-opacity":
      document.documentElement.style.setProperty("--firulete-opacity", data);
      break;

    case "opacity":
      document.documentElement.style.setProperty("--bg-opacity", data);
      break;

    case "bg-size":
      document.documentElement.style.setProperty("--bg-size-scale", `${data}%`);
      break;

    case "frame-style":
      document.documentElement.style.setProperty("--frame-style", data);
      break;
    case "frame-color":
      document.documentElement.style.setProperty("--frame-color", data);
      break;
    case "frame-width":
      document.documentElement.style.setProperty("--frame-width", `${data}px`);
      break;
    case "cat-frame-style":
      document.documentElement.style.setProperty("--cat-frame-style", data);
      // aplicar instant√°neamente
      document.querySelectorAll(".categoria-bloque").forEach(b => {
        b.style.borderStyle = data === "none" ? "none" : data;
        b.style.borderColor = "rgba(0,0,0,0.2)";
        b.style.borderWidth = data === "none" ? "0" : "1.5px";
        b.style.borderRadius = "8px";
        b.style.padding = "8px 10px";
        b.style.marginBottom = "1rem";
      });
      break;
    case "cat-frame-style":
      document.documentElement.style.setProperty("--cat-frame-style", data);
      document.querySelectorAll(".categoria-bloque").forEach(b => {
        b.style.borderStyle = data === "none" ? "none" : data;
      });
      break;

    case "cat-frame-color":
      document.documentElement.style.setProperty("--cat-frame-color", data);
      document.querySelectorAll(".categoria-bloque").forEach(b => {
        b.style.borderColor = data;
      });
      break;

    case "cat-frame-width":
      document.documentElement.style.setProperty("--cat-frame-width", `${data}px`);
      document.querySelectorAll(".categoria-bloque").forEach(b => {
        b.style.borderWidth = `${data}px`;
      });
      break;

    case "get-current-styles":
      const cs = getComputedStyle(document.documentElement);
      const styles = {
        fonts: {
          "nombre-resto": cs.getPropertyValue("--font-nombre-resto").trim(),
          "nombre-slogan": cs.getPropertyValue("--font-nombre-slogan").trim(),
          "categoria": cs.getPropertyValue("--font-categoria").trim(),
          "subcategoria": cs.getPropertyValue("--font-subcategoria").trim(),
          "plato": cs.getPropertyValue("--font-plato").trim(),
          "descripcion": cs.getPropertyValue("--font-descripcion").trim(),
          "precio": cs.getPropertyValue("--font-precio").trim(),
          "info-resto": cs.getPropertyValue("--font-info-resto").trim(),
        },
        colors: {
          "nombre-resto": cs.getPropertyValue("--color-nombre-resto").trim(),
          "nombre-slogan": cs.getPropertyValue("--color-nombre-slogan").trim(),
          "categoria": cs.getPropertyValue("--color-categoria").trim(),
          "subcategoria": cs.getPropertyValue("--color-subcategoria").trim(),
          "precio": cs.getPropertyValue("--color-precio").trim(),
          "info-resto": cs.getPropertyValue("--color-info-resto").trim(),
        },
        sizes: {
          "categoria": cs.getPropertyValue("--size-categoria").trim(),
          "subcategoria": cs.getPropertyValue("--size-subcategoria").trim(),
          "plato": cs.getPropertyValue("--size-plato").trim(),
          "descripcion": cs.getPropertyValue("--size-descripcion").trim(),
          "precio": cs.getPropertyValue("--size-precio").trim(),
          "info": cs.getPropertyValue("--size-info").trim(),
        },
        firulete: cs.getPropertyValue("--firulete").trim(),
        bgOpacity: cs.getPropertyValue("--bg-opacity").trim(),
        bgSize: cs.getPropertyValue("--bg-size-scale").trim(),
        frame: {
          style: cs.getPropertyValue("--frame-style").trim(),
          color: cs.getPropertyValue("--frame-color").trim(),
          width: cs.getPropertyValue("--frame-width").trim(),
        }
      };
      window.parent.postMessage({ type: "current-styles-response", data: styles }, "*");
      break;
          /* === NUEVO: FORMATO / CATEGOR√çAS === */
    case "formato-layout":
      console.log("üìê Aplicando formato desde editor:", data);
      if (typeof aplicarFormatoLayout === "function") {
        aplicarFormatoLayout(data);
      } else {
        console.warn("‚ö†Ô∏è aplicarFormatoLayout no encontrado en men√∫");
      }
      break;

    case "categoria-pos":
      // data = "izq" | "centro" | "der"
      document.body.classList.remove("cat-left","cat-center","cat-right");
      if (data === "izq")    document.body.classList.add("cat-left");
      if (data === "centro") document.body.classList.add("cat-center");
      if (data === "der")    document.body.classList.add("cat-right");
      break;

    case "bg-url":
      const bgDiv = document.querySelector(".print-background");
      if (bgDiv) {
        bgDiv.style.backgroundImage = `url('${data}')`;
        bgDiv.style.backgroundSize = "cover";
        bgDiv.style.backgroundRepeat = "no-repeat";
        bgDiv.style.backgroundPosition = "center center";
      }
      break;

    case "bg-size":
      document.documentElement.style.setProperty("--bg-size-scale", `${data}%`);
      const bgDiv2 = document.querySelector(".print-background");
      if (bgDiv2) bgDiv2.style.backgroundSize = `${data}%`;
      break;

    // === üè™ Logo ===
    case "logo-url":
      const logoEl = document.getElementById("logo-resto");
      if (logoEl) logoEl.src = data;
      break;

    case "logo-size":
    const logo = document.getElementById("logo-resto");
    if (logo) {
        const scale = parseFloat(data) / 100; // 100 ‚Üí 1.0, 50 ‚Üí 0.5, 150 ‚Üí 1.5
        logo.style.transition = "transform 0.25s ease";
        logo.style.transform = `scale(${scale})`;
        logo.style.transformOrigin = "center center"; // üîπ mantiene centrado el escalado
    }
    break;

    case "logo-opacity":
      const logoOpacity = document.getElementById("logo-resto");
      if (logoOpacity) logoOpacity.style.opacity = data;
      break;

    case "logo-margin-top":
    const restoTop = document.querySelector(".resto-top");
    if (restoTop) {
        restoTop.style.marginTop = `${data}px`; // ‚úÖ aplica a todo el bloque
        restoTop.style.transition = "margin-top 0.25s ease";
    }
    break;
    case "logo-gap":
        const restoTopGap = document.querySelector(".resto-top");
        const restoInfo = document.querySelector(".resto-info");

        if (restoTopGap) {
            const val = parseInt(data);
            restoTopGap.style.gap = val >= 0 ? `${val}px` : "0px"; // solo aplica gap si es positivo
            restoTopGap.style.transition = "gap 0.25s ease";
        }

        if (restoInfo) {
            const val = parseInt(data);
            restoInfo.style.marginLeft = val < 0 ? `${val}px` : "0px"; // si es negativo, mueve el texto
            restoInfo.style.transition = "margin-left 0.25s ease";
        }
        break;
    }
  });

  /* üîç Traductor de secciones */
  function getSelector(section) {
    switch (section) {
      case "nombre":
      case "nombre-resto":
        return "#nombre-resto, .resto-info h1";
      case "slogan":
      case "nombre-slogan":
        return "#subtitulo-resto, .resto-slogan, .resto-info h3";
      case "categoria":
        return "h2";
      case "subcategoria":
        // s√≥lo H3 dentro del wrapper del men√∫ (no el H3 del header)
        return "#menuTable h3, #menuTable .sub-bloque h3, .sub-bloque h3";
      case "plato":
        return "#menuTable .menu-plate h4, .menu-plate h4";
      case "descripcion":
        return "#menuTable .menu-description, .menu-description";
      case "precio":
        return "#menuTable .menu-price, .menu-price";
      case "info-resto":
        return ".footer, #menu-frame .footer";
      default:
        return "body";
    }
  }


function aplicarFormatoLayout(layout) {
  const restoTop = document.querySelector('.resto-top');

  // Reset clases base
  document.body.classList.remove(
    "formato-ancho",
    "formato-columnas-reales",
    "header-en-primera",
    "cols-1", "cols-2", "cols-3"
  );

  // Asegurar flex del header
  if (restoTop) {
    restoTop.style.display = "flex";
    restoTop.style.alignItems = "center";
    restoTop.style.justifyContent = "center";
  }

  function go(cols, headerMode) {
    document.body.classList.add(`cols-${cols}`, "formato-columnas-reales");
    if (restoTop) restoTop.style.justifyContent = (headerMode === 'first' ? "flex-start" : "center");
    capturarBloquesOriginales();
    requestAnimationFrame(() => requestAnimationFrame(() => distribuirColumnas(cols, headerMode)));
  }

  switch (String(layout)) {    
    case "1": // 1 Col - Header Centro
    document.body.classList.add("formato-ancho", "cols-1");
    if (restoTop) restoTop.style.justifyContent = "center";
    restaurarAnchoCompleto();
    break;

    case "2": // 2 Cols - Header Centro (fuera de columnas)
      go(2, 'full');
      break;

    case "3": // 2 Cols - Header 1¬∞ Col (doble lateral)
      go(2, 'first');
      if (restoTop) {
        restoTop.style.justifyContent = "center"; // centrado dentro de la primera col
        restoTop.style.textAlign = "center";
      }
      break;

    case "4": // 3 Cols - Header Centro
      go(3, 'full');
      break;

    case "5": // 3 Cols - Header 1¬∞ Col
      go(3, 'first');
      if (restoTop) {
        restoTop.style.justifyContent = "center"; // centrado dentro de la primera col
        restoTop.style.textAlign = "center";
      }
          break;
  }
}

// === Funci√≥n para alinear categor√≠as ===
function ajustarCategorias(pos) {
  const cats = document.querySelectorAll("h2");
  cats.forEach(c => {
    if (pos === "izq") c.style.textAlign = "left";
    else if (pos === "centro") c.style.textAlign = "center";
    else if (pos === "der") c.style.textAlign = "right";
  });
}

// === üîπ APLICAR ESTILOS GUARDADOS (por secci√≥n) ===
function aplicarEstilosGuardados(estilo = {}) {
  if (!estilo) return;

  // üé® 1. Fuentes por secci√≥n
  if (estilo.fonts) {
    Object.entries(estilo.fonts).forEach(([key, val]) => {
      if (!val) return;
      document.documentElement.style.setProperty(`--font-${key}`, val);
      document.querySelectorAll(getSelector(key)).forEach(el => {
        el.style.fontFamily = `'${val}', sans-serif`;
      });
    });
  }

  // üé® 2. Colores por secci√≥n
  if (estilo.colors) {
    Object.entries(estilo.colors).forEach(([key, val]) => {
      if (!val) return;
      document.documentElement.style.setProperty(`--color-${key}`, val);
      document.querySelectorAll(getSelector(key)).forEach(el => {
        el.style.color = val;
      });
    });
  }

  // üî† 3. Tama√±os por secci√≥n
  if (estilo.sizes) {
    Object.entries(estilo.sizes).forEach(([key, val]) => {
      if (!val) return;
      const rem = val.includes("rem") ? val : `${val}rem`;
      document.documentElement.style.setProperty(`--size-${key}`, rem);
      document.querySelectorAll(getSelector(key)).forEach(el => {
        el.style.fontSize = rem;
      });
    });
  }

  // ‚ú® 4. Firulete
  if (estilo.firulete)
    document.documentElement.style.setProperty("--firulete", estilo.firulete);
  if (estilo.firuleteOpacity)
    document.documentElement.style.setProperty("--firulete-opacity", estilo.firuleteOpacity);

  // üñºÔ∏è 5. Fondo
  if (estilo.bgOpacity)
    document.documentElement.style.setProperty("--bg-opacity", estilo.bgOpacity);
  if (estilo.bgSize)
    document.documentElement.style.setProperty("--bg-size-scale", estilo.bgSize);

  // üß± 6. Marco
  if (estilo.frame) {
    if (estilo.frame.style) document.documentElement.style.setProperty("--frame-style", estilo.frame.style);
    if (estilo.frame.color) document.documentElement.style.setProperty("--frame-color", estilo.frame.color);
    if (estilo.frame.width) document.documentElement.style.setProperty("--frame-width", estilo.frame.width);
  }

  // üß© 7. Columnas
  if (estilo.columns) {
    const cols = parseInt(estilo.columns);
    if (cols === 1) restaurarAnchoCompleto();
    else distribuirColumnas(cols, "full");
  }

  console.log("‚úÖ Estilos guardados aplicados:", estilo);
}


})(); 
</script>

</body>
</html>
