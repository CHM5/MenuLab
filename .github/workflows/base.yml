name: Plan Base

on:
  repository_dispatch:
    types: [nuevo_cliente]

jobs:
  generar-menu-base:
    runs-on: ubuntu-latest

    steps:
      # 0) Checkout
      - name: Clonar el repositorio
        uses: actions/checkout@v3

      # 1) Variables del dispatch
      - name: Extraer info del cliente
        id: vars
        run: |
          echo "nombre=${{ github.event.client_payload.nombre }}" >> $GITHUB_OUTPUT
          echo "apellido=${{ github.event.client_payload.apellido }}" >> $GITHUB_OUTPUT
          echo "telefono=${{ github.event.client_payload.telefono }}" >> $GITHUB_OUTPUT
          echo "email=${{ github.event.client_payload.email }}" >> $GITHUB_OUTPUT
          echo "tipo=${{ github.event.client_payload.tipo }}" >> $GITHUB_OUTPUT
          echo "negocio=${{ github.event.client_payload.negocio }}" >> $GITHUB_OUTPUT
          echo "whatsapp=${{ github.event.client_payload.whatsapp }}" >> $GITHUB_OUTPUT
          echo "direccion=${{ github.event.client_payload.direccion }}" >> $GITHUB_OUTPUT
          echo "ciudad=${{ github.event.client_payload.ciudad }}" >> $GITHUB_OUTPUT
          echo "provincia=${{ github.event.client_payload.provincia }}" >> $GITHUB_OUTPUT
          echo "codigo=${{ github.event.client_payload.codigo }}" >> $GITHUB_OUTPUT
          echo "pais=${{ github.event.client_payload.pais }}" >> $GITHUB_OUTPUT
          echo "web=${{ github.event.client_payload.web }}" >> $GITHUB_OUTPUT
          echo "facebook=${{ github.event.client_payload.facebook }}" >> $GITHUB_OUTPUT
          echo "instagram=${{ github.event.client_payload.instagram }}" >> $GITHUB_OUTPUT
          echo "plan=${{ github.event.client_payload.plan }}" >> $GITHUB_OUTPUT
      # 2) Python + deps
      - uses: actions/setup-python@v4
        with: 
          python-version: '3.11'

      - run: pip install google-api-python-client google-auth

      # 3) Ejecutar script de generaciÃ³n
      - name: Ejecutar script de generaciÃ³n segÃºn plan
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          CLIENT_EMAIL: ${{ github.event.client_payload.email }}
        run: |
          echo "Ejecutando script para el plan: ${{ steps.vars.outputs.plan }}"
          if [ "${{ steps.vars.outputs.plan }}" == "0" ]; then
            python scripts/0_sitio_base.py
          elif [ "${{ steps.vars.outputs.plan }}" == "1" ]; then
            python scripts/1_sitio_emprendedor.py
          elif [ "${{ steps.vars.outputs.plan }}" == "2" ]; then
            python scripts/2_sitio_profesional.py
          elif [ "${{ steps.vars.outputs.plan }}" == "3" ]; then
            python scripts/3_sitio_corporativo.py
          else
            echo "âš ï¸ Plan desconocido: ${{ steps.vars.outputs.plan }}"
            exit 1
          fi

      # 4) Capturar URLs que generÃ³ el script
      - name: Capturar rutas generadas
        id: paths
        run: |
          echo "menu_url=$(cat menu_url.txt)" >> $GITHUB_OUTPUT
          echo "sheet_url=$(cat sheet_url.txt)" >> $GITHUB_OUTPUT

      # 5) Commit + push
      - name: Configurar clave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Commit y push del sitio generado (SSH)
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add planes/
          git commit -m "MenÃº ${{ steps.vars.outputs.negocio }}" || echo "Nada para commitear"
          git remote set-url origin git@github.com:CHM5/menulab.git
          git pull --rebase origin main
          git push origin HEAD:main

      # 6) Enviar eâ€‘mail al cliente
      - name: Send eâ€‘mail
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port:    ${{ secrets.SMTP_PORT }}
          username:       ${{ secrets.SMTP_USER }}
          password:       ${{ secrets.SMTP_PASS }}
          subject: "Tu menÃº online estÃ¡ listo ğŸ‰"
          to: ${{ steps.vars.outputs.email }}
          from: "MenuLab <${{ secrets.SMTP_USER }}>"
          html_body: >
            <p>Â¡Hola ${{ steps.vars.outputs.nombre }}!</p>
            <p>AquÃ­ tenÃ©s tu menÃº online:<br>
            <a href="https://menulab.com.ar/${{ steps.paths.outputs.menu_url }}">Ver menÃº</a></p>
            <p>PodÃ©s editar los platos desde esta planilla:<br>
            <a href="${{ steps.paths.outputs.sheet_url }}">Abrir Google Sheet</a></p>
            <p>Â¡Gracias por elegirnos!<br>
            â€” Equipo MenuLab</p>
            <p>PD: Si no podÃ©s ver el menÃº, no dudes en contactarnos.</p>