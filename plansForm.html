<!DOCTYPE html>
<html lang="es">
      <head>
        <title>Planes | MenuLab</title>
        <meta property="og:title" content="MenuLab" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="utf-8" />
        <meta property="twitter:card" content="summary_large_image" />
        <!-- Copia los mismos estilos y fuentes que en index.html -->
        <link rel="stylesheet" href="https://unpkg.com/animate.css@4.1.1/animate.css" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" data-tag="font" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=STIX+Two+Text:wght@400;700&display=swap" data-tag="font" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@100..900&display=swap" data-tag="font" />
        <link rel="stylesheet" href="https://unpkg.com/@teleporthq/teleport-custom-scripts/dist/style.css" />
        <link rel="stylesheet" href="./style.css" />
        <link rel="stylesheet" href="./index.css" />
        <link rel="stylesheet" href="form.css" />
        <script src="plansForm.js" defer></script>
        <style>
        /* Puedes copiar aquí los estilos globales de index.html si no están en style.css */
        </style>
      </head>
        
      <body>
        <div class="container">
            <div class="form-container">
                <div class="form-header">
                    <h1>Aplicación de Plan</h1>
                    <p>Completá los pasos para activar tu sitio en tiempo real.</p>
                </div>
            
                <form id="sponsorshipForm">
                    <div class="form-progress">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <div class="progress-steps">
                            <div class="step" data-step="1">
                                <div class="step-label">Datos Personales</div>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-label">Datos Negocio</div>
                            </div>
                            <div class="step" data-step="3">
                                <div class="step-label">Pago</div>
                            </div>
                            <div class="step" data-step="4">
                                <div class="step-label">Felicitaciones</div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1: Personal Information -->
                    <div class="form-step" data-step="1">
                        <h2>Información Personal</h2>
                        <div class="form-group">
                            <label for="nombre">* Nombre</label>
                            <input type="text" id="nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="apellido">* Apellido</label>
                            <input type="text" id="apellido" name="apellido" required>
                        </div>
                        <div class="form-group">
                            <label for="email">* Email</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="telefono">* Teléfono de contacto</label>
                            <input type="tel" id="telefono" name="telefono" required>
                        </div>
                        <div id="fieldError" class="form-error" style="display:none; color: #d32f2f; margin-top: 8px;">
                            Debés completar todos los campos..
                        </div>
                        <div class="form-buttons" style="justify-content: center;">
                            <button type="button" class="btn prev-btn">Atrás</button>
                            <button type="button" class="btn next-btn">Continuar</button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Sponsorship Details -->
                    <div class="form-step" data-step="2">
                        <div class="form-group">
                            <label for="negocio">Nombre de tu Negocio</label>
                            <input type="text" id="negocio" name="negocio">
                        </div>
                        <div class="form-group">
                            <label for="medio">¿Cómo nos conociste?</label>
                            <select id="medio" name="medio">
                                <option value="" disabled selected>Por favor seleccioná</option>
                                <option value="instagram">Instagram</option>
                                <option value="mercadolibre">Mercado Libre</option>
                                <option value="colegas">Colegas</option>
                                <option value="whatsapp">Whatsapp</option>
                                <option value="email">Email</option>
                                <option value="other">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="comentario">Comentarios Adicionales</label>
                            <textarea id="comentario" name="comentario" rows="4"></textarea>
                        </div>
                        <div class="form-group checkbox-group horizontal">
                            <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
                            <label for="agreeTerms">
                                * Acepto los
                                <a href="legal.html" target="_blank" style="color:#1976d2; text-decoration:underline; font-weight:600;">
                                     términos y condiciones
                                </a>
                            </label>
                        </div>
                        <div id="termsError" class="form-error" style="display:none; color: #d32f2f; margin-top: 8px;">
                            Debes aceptar los términos y condiciones.
                        </div>
                        <div class="form-buttons" style="justify-content: center;">
                            <button type="button" class="btn prev-btn">Atrás</button>
                            <button type="button" class="btn next-btn">Continuar</button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Total -->
                    <div class="form-step" data-step="3">
                        <div id="planInfo"></div>
                        <strong>Total a pagar: $<span class="priceValue">0</span></strong>
                        <div class="success-message">
                            <!-- Ícono MercadoPago -->
                            <div style="display:flex;justify-content:center;margin-bottom:12px;">
                                <img src="MPicon.svg" alt="MercadoPago" style="width:80px;height:auto;">
                            </div>
                            <p>Protegé tu compra con Mercado Pago</p>
                            <p>Luego del pago se te enviará al mail toda la info necesario para comenzar a editar tu carta</p>
                            <div style="display: flex; justify-content: center; gap: 12px; margin-top: 16px;">
                                <button type="button" class="btn prev-btn">Atrás</button>
                                <a id="mpPayButton"
                                    href="#"
                                    name="MP-payButton"
                                    class="blue-button"
                                    target="_blank"
                                    rel="noopener noreferrer">Suscribirme
                                </a>
                            </div>
                            <a id="noPayButton"
                                href="#"
                                class="blue-button"
                                style="display: none; position: relative">Continuar sin pagar
                            </a>
                            <span id="noPayLoader" style="display:none; margin-left:8px; justify-content: center;">⏳ Generando Menú ⏳</span>
                        </div>
                    </div>

                    <!-- Step 4: Success -->
                    <div class="form-step" data-step="4">
                        <div class="success-message">
                            <div class="success-icon">✓</div>
                            <h2>¡Felicitaciones!</h2>
                            <p>Tu compra fue procesada exitosamente. En breve recibirás un mail con los accesos y tu sitio editable.</p>
                            <br>¿Dudas? Escribinos con el codigo de tu compra a al whatsapp o mail de contacto.</br>
                        </div>
                        <div class="form-buttons" style="justify-content: center;">
                            <button type="button" id="resetForm" class="btn">Realizar otra compra</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!--Footer4 component-->
        <footer4-wrapper class="footer4-wrapper">
            <footer class="footer4-footer7 thq-section-padding">
                <div class="footer4-max-width thq-section-max-width">
                    <div class="footer4-content">
                        <div class="footer4-credits">
                            <div class="thq-divider-horizontal"></div>
                            <div class="footer4-row">
                                <div class="footer4-container">
                                    <span class="thq-body-small">© 2025 MenuLab</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        </footer4-wrapper>
                        
        
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const planMap = {
                    0: {
                        name: "Plan Base",
                        price: "GRATIS",
                        features: [                        
                        "Menú Online",
                        "Actualizaciones Ilimitadas",
                        "Diseño Responsivo",
                        "Hasta 25 ítems en tu carta",
                        "Datos del Negocio",
                        "Certificado SSL"
                    ]
                },
                1: {
                    name: "Plan Emprendedor Mensual",
                    price: "$18.000",
                    features: [
                        "Código QR",
                        "Sin Publicidad",
                        "Hosting 24/7",
                        "Ítems Ilimitados en tu carta",
                        "Búsqueda de platos",
                        "Atención Virtual",

                        "Menú Online",
                        "Actualizaciones Ilimitadas",
                        "Diseño Responsivo",
                        "Data Negocio",
                        "Certificado SSL",

                        "5% OFF en Productos"
                    ],
                    mpLink: "https://www.mercadopago.com.ar/subscriptions/checkout?preapproval_plan_id=2c938084966c84bc01969976d53f14d2"
                },
                2: {
                    name: "Plan Profesional Mensual",
                    price: "$36.000",
                    features: [
                        "Integración WhatsApp",
                        "Integración Rappi/PedidosYa",
                        "Integración Instagram/Facebook",
                        "Atención Personalizada",
                        "Tema personalizable",
                        
                        "Código QR",
                        "Sin Publicidad",
                        "Hosting 24/7",
                        "Ítems Ilimitados en tu carta",
                        "Búsqueda de platos",
                        "Menú Online",
                        "Actualizaciones Ilimitadas",
                        "Diseño Responsivo",
                        "Data Negocio",
                        "Certificado SSL",

                        "10% OFF en productos"
                    ],
                    mpLink: "https://www.mercadopago.com.ar/subscriptions/checkout?preapproval_plan_id=2c9380849696ea8201969bd7708d01ac"
                },
                3: {
                    name: "Plan Corporativo Mensual",
                    price: "$72.000",
                    features: [
                        "Fotos de tus Platos",
                        "Promos por temporada",
                        "Pedidos por web",
                        "Dominio Propio",
                        "Atención Prioritaria",
                        
                        "Integración WhatsApp",
                        "Integración Rappi/PedidosYa",
                        "Integración Instagram/Facebook",
                        "Atención Personalizada",
                        "Código QR",
                        "Sin Publicidad",
                        "Hosting 24/7",
                        "Ítems Ilimitados en tu carta",
                        "Búsqueda de platos",
                        "Menú Online",
                        "Actualizaciones Ilimitadas",
                        "Diseño Responsivo",
                        "Data Negocio",
                        "Certificado SSL",

                        "15% OFF en productos"
                    ],
                    mpLink: "https://www.mercadopago.com.ar/subscriptions/checkout?preapproval_plan_id=2c938084968c9eaa01969bd7f0f4062c"
                },
                4: {
                    name: "Plan Emprendedor Anual",
                    price: "$180.000",
                    features: [
                        "Código QR",
                        "Sin Publicidad",
                        "Hosting 24/7",
                        "Ítems Ilimitados en tu carta",
                        "Búsqueda de platos",
                        "Atención Virtual",

                        "Menú Online",
                        "Actualizaciones Ilimitadas",
                        "Diseño Responsivo",
                        "Data Negocio",
                        "Certificado SSL",
                        
                        "10% OFF en productos"
                    ],
                    mpLink: "https://www.mercadopago.com.ar/subscriptions/checkout?preapproval_plan_id=2c9380849721f5e501972934c13602ad"
                },
                5: {
                    name: "Plan Profesional Anual",
                    price: "$360.000",
                    features: [
                        "Integración WhatsApp",
                        "Integración Rappi/PedidosYa",
                        "Integración Instagram/Facebook",
                        "Atención Personalizada",
                        "Tema personalizable",
                        
                        "Código QR",
                        "Sin Publicidad",
                        "Hosting 24/7",
                        "Ítems Ilimitados en tu carta",
                        "Búsqueda de platos",
                        "Menú Online",
                        "Actualizaciones Ilimitadas",
                        "Diseño Responsivo",
                        "Data Negocio",
                        "Certificado SSL",
                        
                        "20% OFF en productos"
                        
                    ],
                    mpLink: "https://mpago.la/1FzYWEk"
                },
                6: {
                    name: "Plan Corporativo Anual",
                    price: "$720.000",
                    features: [
                        "Fotos de tus Platos",
                        "Promos por temporada",
                        "Pedidos por web",
                        "Dominio Propio",
                        "Atención Prioritaria",
                        
                        "Integración WhatsApp",
                        "Integración Rappi/PedidosYa",
                        "Integración Instagram/Facebook",
                        "Atención Personalizada",
                        "Código QR",
                        "Sin Publicidad",
                        "Hosting 24/7",
                        "Ítems Ilimitados en tu carta",
                        "Búsqueda de platos",
                        "Menú Online",
                        "Actualizaciones Ilimitadas",
                        "Diseño Responsivo",
                        "Data Negocio",
                        "Certificado SSL",
                        "30% OFF en productos"
                    ],
                    mpLink: "https://mpago.la/2sL5gCq"
                }
            };
            
            // Lee los parámetros de la URL
            const params = new URLSearchParams(window.location.search);
            const planParam = params.get('plan');
            const stepParam = params.get('step');
            const planInfoDiv = document.getElementById('planInfo');
            const priceSpan = document.querySelector('.priceValue');

            if (planParam && planMap[planParam]) {
                const plan = planMap[planParam];
                if (planInfoDiv) {
                    planInfoDiv.innerHTML = `
                    <h3>${plan.name}</h3>
                    <ul style="margin-bottom:10px; padding-right: 1.5rem; ">
                        ${plan.features.map(f => `<li>${f}</li>`).join('')}
                    </ul>
                    `;
                }
                if (priceSpan) {
                    priceSpan.textContent = plan.price.replace('$', '').replace('.', '');
                }
            } else {
                if (planInfoDiv) {
                    planInfoDiv.innerHTML = `<h3>Plan no especificado</h3>`;
                }
            }

            // --- Manejo de pasos del formulario ---
            let currentStep = 1;
            const steps = document.querySelectorAll('.form-step');
            const progressSteps = document.querySelectorAll('.progress-steps .step');
            if (stepParam && !isNaN(stepParam) && Number(stepParam) >= 1 && Number(stepParam) <= steps.length) {
                currentStep = Number(stepParam);
            }

            function showStep(step) {
                steps.forEach((el, idx) => {
                    el.classList.toggle('active', idx === step - 1);
                });
                progressSteps.forEach((el, idx) => {
                    el.classList.toggle('active', idx === step - 1);
                });
            }

            document.querySelectorAll('.next-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
                    const requiredFields = currentStepElement.querySelectorAll('[required]');
                    let isValid = true;

                    requiredFields.forEach(field => {
                    field.style.borderColor = '';
                    if (!field.value.trim()) {
                        field.style.borderColor = 'red';
                        field.classList.add('shake');
                        isValid = false;
                        setTimeout(() => field.classList.remove('shake'), 500);
                        console.warn('⛔ Debés completar todos los campos');
                    }
                    });

                    if (currentStep === 2) {
                        const checkbox = document.getElementById('agreeTerms');
                        const errorBox = document.getElementById('termsError');
                        
                        if (!checkbox.checked) {
                            errorBox.style.display = 'block';
                            console.warn('⛔ Debés aceptar los términos y condiciones');
                            isValid = false;
                        } else {
                            errorBox.style.display = 'none';
                        }
                    }

                    if (!isValid) {
                    console.warn(`⛔ Campos incompletos en paso ${currentStep}`);
                    return; // No avanza si algún campo está vacío
                    }

                    console.log(`✅ Todos los campos del paso ${currentStep} están completos.`);

                    
                    if (currentStep < steps.length) {
                    currentStep++;
                    showStep(currentStep);
                    }
                });
            });

            document.querySelectorAll('.prev-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    if (currentStep > 1) {
                        currentStep--;
                        showStep(currentStep);
                    }
                });
            });

            // Inicializa mostrando el paso correcto
            showStep(currentStep);

            const mpPayButton = document.getElementById('mpPayButton');
            if (mpPayButton && planParam && planMap[planParam] && planMap[planParam].mpLink) {
                // Cambiamos el botón: ahora NO tiene el href directo, sino un click handler
                mpPayButton.removeAttribute('href');
                mpPayButton.style.display = "";

                mpPayButton.addEventListener('click', function (e) {
                    e.preventDefault();

                    // Capturamos los datos del formulario
                    const form = document.getElementById('sponsorshipForm');
                    const formData = new FormData(form);
                    const dataObj = {
                        nombreCompleto: `${formData.get("nombre")} ${formData.get("apellido")}`.trim(),
                        email: formData.get("email"),
                        telefono: formData.get("telefono"),
                        negocio: formData.get("negocio"),
                        medio: formData.get("medio"),
                        comentario: formData.get("comentario"),
                        plan: planParam,
                        external_reference: `plan_${planParam}_${Date.now()}`
                    };
                    console.log("📦 Enviando registro previo:", dataObj);
                    // Enviamos al Apps Script antes de redirigir
                    fetch("https://script.google.com/macros/s/AKfycbyLSRd2Fa4Czd6N8j8KQA2U3ULgP0fmcPyEeoZnRPzfIuDlWK5tMRGkVYx_YwFBES6J/exec", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams(dataObj).toString()
                    })
                    .then(res => res.json())
                    .then(json => {
                    if (json.init_point) {
                        console.log("✅ init_point recibido, redirigiendo...");
                        window.location.href = json.init_point;
                    } else {
                        alert("Error generando link de pago");
                    }
                    })
                    .catch(err => {
                    console.error("❌ Error creando la suscripción:", err);
                    alert("Error creando la suscripción.");
                    });
                });
            } else if (mpPayButton) {
                mpPayButton.style.display = "none"; // Ocultar si no hay link (ejemplo: Plan Base)
            }

            let isLoading = false;
            const noPayButton = document.getElementById('noPayButton');
            if (noPayButton) {
                // Mostramos el botón si el plan no tiene link de MercadoPago (plan base)
                if (!planMap[planParam] || !planMap[planParam].mpLink) {
                  noPayButton.style.display = "";
                  
                  noPayButton.addEventListener('click', function (e) {
                    if (isLoading) return; // Previene doble click
                    isLoading = true;
                    e.preventDefault();
                    
                    noPayButton.disabled = true;
                    const loader = document.getElementById('noPayLoader');
                    loader.style.display = 'inline-block';

                    const form = document.getElementById('sponsorshipForm');
                    const formData = new FormData(form);
                    const uniqueRef = `plan_${planParam}_${Date.now()}`;
                    const formDataObj = {};

                    formDataObj.nombreCompleto = `${formData.get("nombre")} ${formData.get("apellido")}`.trim();
                    formDataObj.email = formData.get("email");
                    formDataObj.telefono = formData.get("telefono");
                    formDataObj.negocio = formData.get("negocio");
                    formDataObj.medio = formData.get("medio");
                    formDataObj.comentario = formData.get("comentario");
                    formDataObj.plan = "0";
                    formDataObj.pago = false;
                    formDataObj.external_reference = uniqueRef;
                    formDataObj.redirect = `successpayment.html`;
                    console.log("🔍 formDataObj que se enviará:", formDataObj);
                    console.log("📦 Payload final:", new URLSearchParams(formDataObj).toString());
                    console.log("a");

                    // Enviar datos a Apps Script usando form-urlencoded
                    const url = "https://script.google.com/macros/s/AKfycbyLSRd2Fa4Czd6N8j8KQA2U3ULgP0fmcPyEeoZnRPzfIuDlWK5tMRGkVYx_YwFBES6J/exec"
                    fetch(url, {
                        method: "POST",
                        mode: "no-cors",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: new URLSearchParams(formDataObj).toString()
                    })
                    .then(response => {
                        console.log("✅ Respuesta recibida del servidor. Status:", response.status);
                        return response.text();
                    })                    
                    .then(text => {
                      console.log("✅ Enviado a Apps Script:", text);
                      // Avanzar al paso 4 (éxito)
                      currentStep = 4;
                      showStep(currentStep);
                      console.log("➡️ Avanzado al paso 4");
                      // Redirigir a la URL de éxito (si se definió)
                      if (formDataObj.redirect) {
                        console.log("🔁 Redirigiendo a:", formDataObj.redirect);
                        window.location.href = formDataObj.redirect;
                      } else {
                        alert("Formulario enviado pero sin redirección.");
                      }
                    })
                    .catch(err => {
                      console.error("❌ Error al enviar a Apps Script:", err);
                      alert("Error crítico antes de intentar enviar los datos.");
                    })
                  });
                }
            }

            // Envia preapproval_id si está presente en la URL (pago exitoso)
            const preapprovalId = params.get('preapproval_id');
            if (preapprovalId) {
                console.log("🔁 Detected preapproval_id, enviando a Apps Script:", preapprovalId);
                
                fetch("https://script.google.com/macros/s/AKfycbyLSRd2Fa4Czd6N8j8KQA2U3ULgP0fmcPyEeoZnRPzfIuDlWK5tMRGkVYx_YwFBES6J/exec", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams({ preapproval_id: preapprovalId }).toString()
                })
                .then(() => {
                    console.log("✅ Preapproval enviado correctamente. Mostrando paso 4");
                    // Avanza al paso 4 directamente
                    currentStep = 4;
                    showStep(currentStep);
                })
                .catch(err => {
                    console.error("❌ Error al enviar preapproval_id:", err);
                });
            }
            });
    </script>
</body>

</html>